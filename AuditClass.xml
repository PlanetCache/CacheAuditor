<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24" zv="Cache for UNIX (IBM AIX for System P5-64) 2010.1.4 (Build 803U)" ts="2011-04-15 13:13:59">
<Class name="Util.AuditClass">
<Super>%Persistent</Super>
<TimeChanged>62196,47573.46648</TimeChanged>
<TimeCreated>62180,62915.069152</TimeCreated>

<UDLText name="T">
<Content><![CDATA[
/*
		Author: Dan McCracken
		Date: 4/14/2011
		
		Class that will audit any persistent class that extends it, and store the data in Spectrum.Util.AuditStorageClass.
		
	*/
]]></Content>
</UDLText>

<Method name="%OnBeforeSave">
<Description><![CDATA[
This callback method is invoked by the <METHOD>%Save</METHOD> method to 
provide notification that the object is being saved. It is called after 
the object's data has been successfully written to disk.

<P><VAR>insert</VAR> will be set to 1 if this object is being saved for the first time.

<P>If this method returns an error then the call to <METHOD>%Save</METHOD> will fail.]]></Description>
<CodeMode>objectgenerator</CodeMode>
<FormalSpec>insert:%Boolean</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	// %OnBeforeSave - check to see if the ..%Id() has value.  If it does not, then it's an INSERT. Else its an UPDATE.
	// If its an UPDATE, audit each field to see if the value changed. Do a lookup off OrefId and embedded SQL..
		// If it did change, then log that to the Dump field as a HashPair of some kind: "DepAlias=>From PDCL To PDOD"
	Do %code.WriteLine(" Set saveAudit = 1")
	
	Do %code.WriteLine(" Set obj = ##class(Spectrum.Util.AuditClassStorage).%New()")
	Do %code.WriteLine(" Set obj.OrefId = ..%Id()")
	Do %code.WriteLine(" Set obj.ClassName = ..%ClassName(1)")
	Do %code.WriteLine(" Set obj.UserName = $USERNAME")
	
	Do %code.WriteLine(" If (insert) {")
		// Get next ID value for this class, and assign that as the OrefId
		// Take the largest ID from the audited table and assign the next one to a new add
	Do %code.WriteLine(" 	Set maxID = """"")
	Do %code.WriteLine(" 	Set obj.AuditType = ""INSERT""")
	
	// Find the global name the persistent class being extended, so we can do a %code.WriteLine with it to get the next ID subscript
	// Open dictionary access for class being extended.
	S class = ##class(%Dictionary.ClassDefinition).%OpenId(%compiledclass.Name)
	// Check the storage definition profile name.. if null, use "Default"
	S storageName = class.StorageStrategy
	If (storageName = "") {
		S storageName = "Default"
	}
	// Open the storage definition class for the class/def combo
	S storageDefinition = ##class(%Dictionary.StorageDefinition).%OpenId(%compiledclass.Name_"||"_storageName)
	// Access the DataLocation property, which is the global name being used by the persistent class
	S globalName = storageDefinition.DataLocation
	Do %code.WriteLine(" 	Set maxID = "_globalName)	
		
	Do %code.WriteLine(" 	Set obj.OrefId = maxID + 1")
	Do %code.WriteLine(" }")
	Do %code.WriteLine(" Else {")
		// Do not save the audit object if it was not modified.
	Do %code.WriteLine(" 	If (..%ObjectModified()) {	Set obj.AuditType = ""UPDATE"" }")
	Do %code.WriteLine(" 	Else { Set saveAudit = 0 }")
	Do %code.WriteLine(" }")
	
	Do %code.WriteLine(" If (saveAudit) {")
	
	// Rip through each property of the class.. that does not start with a %
	For i = 1:1:%compiledclass.Properties.Count() {
        Set prop = %compiledclass.Properties.GetAt(i).Name
        IF ($EXTRACT(prop) '= "%") {
	        Do %code.WriteLine(" Set sc = obj.AppendHashPair("""_prop_""",.."_prop_")")
        }
    }

	Do %code.WriteLine(" Do obj.%Save()")
	Do %code.WriteLine(" }")
	
	Do %code.WriteLine(" Quit $$$OK")
	
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="%OnDelete">
<Description><![CDATA[
This callback method is invoked by the <METHOD>%Delete</METHOD> method to 
provide notification that the object specified by <VAR>oid</VAR> is being deleted.

<P>If this method returns an error then the object will not be deleted.]]></Description>
<ClassMethod>1</ClassMethod>
<CodeMode>objectgenerator</CodeMode>
<FormalSpec>oid:%ObjectIdentity</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	// Open the instance of the soon to be deleted object from the oid.
	Do %code.WriteLine(" Set deleteMe = ..%Open(oid)")
	
	Do %code.WriteLine(" Set obj = ##class(Spectrum.Util.AuditClassStorage).%New()")
	Do %code.WriteLine(" Set obj.OrefId = deleteMe.%Id()")
	Do %code.WriteLine(" Set obj.ClassName = deleteMe.%ClassName(1)")
	Do %code.WriteLine(" Set obj.UserName = $USERNAME")
	
	Do %code.WriteLine(" Set obj.AuditType = ""DELETE""")
	
	// Rip through each property of the class.. that does not start with a %
	For i = 1:1:%compiledclass.Properties.Count() {
        Set prop = %compiledclass.Properties.GetAt(i).Name
        IF ($EXTRACT(prop) '= "%") {
	        Do %code.WriteLine(" Set sc = obj.AppendHashPair("""_prop_""",deleteMe."_prop_")")
        }
    }
    
	Do %code.WriteLine(" Do obj.%Save()")
	
	Do %code.WriteLine(" Quit $$$OK")
	
	Quit $$$OK
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Util.AuditClassD</DataLocation>
<DefaultData>AuditClassDefaultData</DefaultData>
<IdLocation>^Util.AuditClassD</IdLocation>
<IndexLocation>^Util.AuditClassI</IndexLocation>
<StreamLocation>^Util.AuditClassS</StreamLocation>
<Data name="AuditClassDefaultData">
<Structure>listnode</Structure>
<Subscript/>
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
